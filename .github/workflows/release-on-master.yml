name: release on master

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UPX
        run: |
          sudo apt-get update
          sudo apt-get install -y upx
          upx --version

      - name: Set up Go from go.mod
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Compute release name/tag (tag if points-at SHA, else SHA)
        id: rel
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          tags="$(git tag --points-at "${GITHUB_SHA}" || true)"
          if [[ -n "${tags}" ]]; then
            # если тегов несколько — берём "наибольший" по version-sort
            chosen="$(printf '%s\n' "${tags}" | sort -V | tail -n 1)"
            echo "ref=${chosen}" >> "${GITHUB_OUTPUT}"
          else
            shortsha="$(git rev-parse --short=7 "${GITHUB_SHA}")"
            echo "ref=${shortsha}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Build (standard cross-compile)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          # Список таргетов: "goos/goarch[:ext]"
          targets=(
            "linux/amd64"
            "linux/arm64"
            "linux/386"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64:.exe"
            "windows/arm64:.exe"
          )

          for t in "${targets[@]}"; do
            base="${t%%:*}"
            ext=""
            if [[ "${t}" == *:* ]]; then ext="${t##*:}"; fi

            GOOS="${base%/*}"
            GOARCH="${base#*/}"
            out="dist/cage_${GOOS}_${GOARCH}${ext}"

            echo "==> building ${GOOS}/${GOARCH} -> ${out}"
            export CGO_ENABLED=0 GOOS GOARCH

            ldflags="-s -w"
            if [[ "${GOOS}" == "linux" ]]; then
              # если хочешь повторить твой linux-static подход
              ldflags="${ldflags} -extldflags=-static"
            fi

            go build -tags=osusergo,netgo -ldflags="${ldflags}" -o "${out}" .
          
            if [[ "${GOOS}" != "darwin" && ! ( "${GOOS}" == "windows" && "${GOARCH}" == "arm64" ) ]]; then
              echo "==> UPXing ${out}"
              upx --brute "$out"
            fi

            sha256sum "${out}" > "${out}.sha256"
          done

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.ref }}
          name: ${{ steps.rel.outputs.ref }}
          target_commitish: ${{ github.sha }}
          files: |
            dist/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
